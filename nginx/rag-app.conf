# Nginx configuration for RAG Application
# UI at /rag/ui, API at /rag/api, Docs at /rag/api/docs
#
# This file can be used in two ways:
# 1. As a standalone server block (default)
# 2. Include the location blocks in an existing server
#
# For option 2, use: include /path/to/rag-locations.conf;

# Upstream servers (place in http block or here)
upstream rag_backend {
    server 127.0.0.1:8000;
    keepalive 32;
}

upstream rag_frontend {
    server 127.0.0.1:3000;
}

server {
    listen 80;  # Using port 8080 to avoid conflict with existing localhost:80
    server_name localhost 127.0.0.1;

    # Increase timeouts for long-running requests (like ingestion)
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Frontend UI at /rag/ui
    location /rag/ui/ {
        # For development (proxy to React dev server)
        # React dev server serves from root, so we strip /rag/ui prefix
        rewrite ^/rag/ui/(.*)$ /$1 break;
        proxy_pass http://rag_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Handle /rag/ui without trailing slash
    location = /rag/ui {
        return 301 /rag/ui/;
    }
    
    # React dev server static files and other assets
    # These are requested from root paths like /static/js/bundle.js
    location /static/ {
        proxy_pass http://rag_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # React dev server manifest and other root files
    location = /manifest.json {
        proxy_pass http://rag_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    location = /favicon.ico {
        proxy_pass http://rag_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    # WebSocket for React hot reload
    location /ws {
        proxy_pass http://rag_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # For production (serve static files)
    # Uncomment this block and comment the above for production
    # location /rag/ui {
    #     alias /home/vishwa/llm/llm-rag-app/frontend/build;
    #     try_files $uri $uri/ /rag/ui/index.html;
    #     
    #     # Cache static assets
    #     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    #         expires 1y;
    #         add_header Cache-Control "public, immutable";
    #     }
    # }

    # Backend API at /rag/api
    # The frontend API calls already include /api/ prefix (e.g., /api/auth/login)
    # So /rag/api/api/auth/login -> /api/auth/login (strip /rag/api, keep /api)
    location /rag/api/ {
        # Strip /rag/api prefix only, the request already has /api/ in it
        rewrite ^/rag/api(/.*)$ $1 break;
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        
        # IMPORTANT: Use $host:$server_port to preserve port in redirects
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host:$server_port;
        proxy_set_header X-Forwarded-Prefix /rag/api;
        
        # Handle redirects from backend - rewrite Location header
        proxy_redirect ~^(https?://)[^/]+(/.*)?$ $1$host:$server_port/rag/api$2;
        
        # For WebSocket support (if needed)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Increase body size for file uploads
        client_max_body_size 100M;
    }

    # API Docs endpoint - /rag/api/docs -> /api/docs
    location = /rag/api/docs {
        rewrite ^/rag/api/docs$ /api/docs break;
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host:$server_port;
    }
    
    # API OpenAPI JSON - /rag/api/openapi.json -> /api/openapi.json
    location = /rag/api/openapi.json {
        rewrite ^/rag/api/openapi.json$ /api/openapi.json break;
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host:$server_port;
    }
    
    # Swagger UI requests openapi.json from /api/openapi.json (relative to root)
    # This handles that request when accessing docs via /rag/api/docs
    location = /api/openapi.json {
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host:$server_port;
    }
    
    # API Redoc - /rag/api/redoc -> /api/redoc
    location = /rag/api/redoc {
        rewrite ^/rag/api/redoc$ /api/redoc break;
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host:$server_port;
    }

    # Health check endpoint - maps /rag/api/health to /health
    location = /rag/api/health {
        rewrite ^/rag/api/health$ /health/ break;
        proxy_pass http://rag_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host:$server_port;
    }

    # Redirect root to UI
    location = /rag {
        return 301 /rag/ui;
    }

    location = /rag/ {
        return 301 /rag/ui;
    }

    # Root redirect
    location = / {
        return 301 /rag/ui;
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
